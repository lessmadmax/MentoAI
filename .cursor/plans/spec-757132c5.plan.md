<!-- 757132c5-bfdd-491f-a7ef-fd850dd5c7ad 9ab3ea12-8831-4906-b65b-471d2bc9252b -->
# 500 에러 근본 해결 및 API 통합 계획

## 1. 500 에러 근본 해결 (최우선)

### 1.1 문제 진단

- **현재 에러**: `ObjectOptimisticLockingFailureException: Row was updated or deleted by another transaction`
- **근본 원인**: `orphanRemoval = true`와 `EntityManager.remove()` + `clear()` 조합에서 JPA 엔티티 상태 추적 실패
- **발생 시점**: 새 사용자 프로필 생성 시 특히 빈번

### 1.2 해결 전략 A: Repository 기반 삭제 (권장)

**1.2.1 자식 엔티티 Repository 생성**

**파일: `src/main/java/com/mentoai/mentoai/repository/UserProfileAwardRepository.java`** (신규)

```java
public interface UserProfileAwardRepository extends JpaRepository<UserProfileAwardEntity, Long> {
    @Modifying
    @Query("DELETE FROM UserProfileAwardEntity a WHERE a.profile.userId = :userId")
    void deleteByUserId(@Param("userId") Long userId);
}
```

**파일: `src/main/java/com/mentoai/mentoai/repository/UserProfileCertificationRepository.java`** (신규)

```java
public interface UserProfileCertificationRepository extends JpaRepository<UserProfileCertificationEntity, Long> {
    @Modifying
    @Query("DELETE FROM UserProfileCertificationEntity c WHERE c.profile.userId = :userId")
    void deleteByUserId(@Param("userId") Long userId);
}
```

**파일: `src/main/java/com/mentoai/mentoai/repository/UserProfileExperienceRepository.java`** (신규)

```java
public interface UserProfileExperienceRepository extends JpaRepository<UserProfileExperienceEntity, Long> {
    @Modifying
    @Query("DELETE FROM UserProfileExperienceEntity e WHERE e.profile.userId = :userId")
    void deleteByUserId(@Param("userId") Long userId);
}
```

**1.2.2 UserProfileService 완전 재작성**

**파일: `src/main/java/com/mentoai/mentoai/service/UserProfileService.java`**

- EntityManager 의존성 제거
- Repository 삭제 메서드 사용
- 새 프로필 생성 플로우:

  1. 빈 프로필 엔티티 생성 및 저장 (saveAndFlush)
  2. 트랜잭션 내에서 엔티티 다시 로드 (findById)
  3. UserProfileMapper.apply() 호출
  4. 최종 저장 (saveAndFlush)

- 기존 프로필 업데이트 플로우:

  1. 프로필 로드 (findById)
  2. Repository의 deleteByUserId()로 자식 엔티티 삭제
  3. flush() 호출
  4. 컬렉션 clear() (이미 삭제됨)
  5. UserProfileMapper.apply() 호출
  6. 최종 저장 (saveAndFlush)

### 1.3 해결 전략 B: orphanRemoval 제거 (대안)

만약 전략 A가 실패할 경우:

**파일: `src/main/java/com/mentoai/mentoai/entity/UserProfileEntity.java`**

- `orphanRemoval = true` 제거
- `cascade = CascadeType.ALL`만 유지
- 수동 삭제 관리

### 1.4 테스트 및 검증

- 새 사용자 프로필 생성 테스트 (여러 번 반복)
- 기존 사용자 프로필 업데이트 테스트
- 동시 요청 시뮬레이션
- 데이터베이스 직접 확인
- 에러 로그 상세 분석

## 2. 사용자 데이터 저장 완벽 검증

### 2.1 저장 검증 로직 추가

**파일: `src/main/java/com/mentoai/mentoai/service/UserProfileService.java`**

- 저장 후 즉시 조회하여 검증
- 모든 필드 값 비교
- 자식 엔티티 개수 확인
- 트랜잭션 커밋 확인

### 2.2 로깅 강화

- 각 단계별 상세 로그
- 엔티티 상태 로그
- SQL 쿼리 로그 확인

## 3. Google Gemini API 통합

### 3.1 설정

**파일: `src/main/resources/application.properties`**

```
application.gemini.api-key=${GEMINI_API_KEY}
application.gemini.api-url=https://generativelanguage.googleapis.com/v1beta
application.gemini.model=gemini-pro
```

**파일: `src/main/java/com/mentoai/mentoai/config/GeminiConfig.java`** (신규)

- RestTemplate Bean 구성
- API 키 주입
- 타임아웃 설정

### 3.2 서비스 구현

**파일: `src/main/java/com/mentoai/mentoai/service/GeminiService.java`** (신규)

- `generateText(String prompt)`: 텍스트 생성
- `generateEmbedding(String text)`: 임베딩 생성
- `analyzeProfile(UserProfileEntity)`: 프로필 분석 및 향상
- 에러 처리 및 재시도
- Rate limiting

### 3.3 통합

- RecommendService에 Gemini 임베딩 통합
- 프로필 자동 향상 기능

## 4. ETL 파이프라인 연동

### 4.1 아키텍처

- Webhook 수신 엔드포인트
- 주기적 동기화 작업
- 데이터 형식 표준화

### 4.2 구현

**파일: `src/main/java/com/mentoai/mentoai/service/ETLIntegrationService.java`** (신규)

- `syncUserData()`: 사용자 데이터 동기화
- `syncActivityData()`: 활동 데이터 동기화
- `receiveETLData()`: ETL 데이터 수신

**파일: `src/main/java/com/mentoai/mentoai/controller/ETLController.java`** (신규)

- `POST /etl/sync`: 동기화 트리거
- `POST /etl/webhook`: Webhook 수신
- `GET /etl/status`: 상태 확인

**파일: `src/main/java/com/mentoai/mentoai/config/ScheduledTasksConfig.java`** (신규)

- `@Scheduled` 작업 구성
- 주기적 동기화

## 구현 우선순위

1. **1단계 (완료)**: 500 에러 해결 ✅

   - UserProfileService 수정 완료 (persist() 사용, setUserId() 제거)

2. **2단계 (진행 중)**: 렌더 데이터베이스 초기화

   - Flyway 마이그레이션 히스토리 확인
   - 필요시 데이터베이스 초기화 스크립트 실행
   - 마이그레이션 재실행 확인

3. **3단계**: Gemini API 연결 및 통합

   - GeminiService 구현
   - RecommendService에 Gemini 임베딩 통합
   - 의미 기반 검색 개선

4. **4단계**: 사용자 점수 산정 및 활동 추천

   - RoleFitService와 RecommendService 통합
   - 사용자 프로필 기반 점수 계산
   - 점수 기반 활동 추천

5. **5단계**: 유저 데이터베이스 업데이트 검증

   - 프로필 저장 테스트
   - 모든 필드 저장 확인
   - 자식 엔티티 저장 확인